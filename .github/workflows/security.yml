name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays at midnight
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  # ===========================================================================
  # CodeQL Analysis
  # ===========================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp
          queries: +security-extended,security-and-quality

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            libjsoncpp-dev \
            libyaml-cpp-dev \
            libpaho-mqtt-dev \
            libpaho-mqttpp-dev \
            libcurl4-openssl-dev \
            libssl-dev

      - name: Build
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DIPB_SINK_CONSOLE=ON \
            -DIPB_SINK_SYSLOG=ON \
            -DIPB_BUILD_GATE=ON
          cmake --build build --parallel $(nproc)

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:cpp"

  # ===========================================================================
  # SBOM Generation (Software Bill of Materials)
  # ===========================================================================
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Generate CycloneDX SBOM
        uses: anchore/sbom-action@v0
        with:
          format: cyclonedx-json
          output-file: sbom.cyclonedx.json

      - name: Upload SBOM Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom.spdx.json
            sbom.cyclonedx.json
          retention-days: 90

      - name: SBOM Summary
        run: |
          echo "## SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Software Bill of Materials has been generated in SPDX and CycloneDX formats." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from workflow artifacts." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Dependency Review (for PRs)
  # ===========================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-24.04
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        continue-on-error: true
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
          comment-summary-in-pr: on-failure

  # ===========================================================================
  # Dependency Scanning
  # ===========================================================================
  dependency-scan:
    name: Dependency Scan
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Known Vulnerabilities
        run: |
          echo "Checking dependencies for known vulnerabilities..."

          # Check CMakeLists.txt for dependency versions
          echo "Dependencies found in CMakeLists.txt:"
          grep -E "find_package|pkg_check_modules" CMakeLists.txt || true

          # Create dependency report
          cat > dependency-report.md << 'EOF'
          # Dependency Security Report

          ## Direct Dependencies

          | Dependency | Version | Status |
          |------------|---------|--------|
          | jsoncpp | System | Check CVE database |
          | yaml-cpp | System | Check CVE database |
          | paho-mqtt | System | Check CVE database |
          | openssl | System | Check CVE database |
          | libcurl | System | Check CVE database |

          ## Recommendations

          - Keep all system packages updated
          - Consider using vcpkg/conan for version pinning
          - Enable automatic security updates
          EOF

          cat dependency-report.md

      - name: Scan with OSV-Scanner
        uses: google/osv-scanner-action@v2.3.1
        continue-on-error: true

      - name: Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report.md

  # ===========================================================================
  # Secret Scanning
  # ===========================================================================
  secrets-scan:
    name: Secret Scanning
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan with Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Install truffleHog
        run: |
          pip install truffleHog3

      - name: Scan for Secrets
        run: |
          trufflehog filesystem . \
            --only-verified \
            --fail \
            --json > secrets-scan.json 2>&1 || true

          if [ -s secrets-scan.json ]; then
            echo "Potential secrets found!"
            cat secrets-scan.json
          else
            echo "No secrets detected"
          fi
        continue-on-error: true

      - name: Check for Hardcoded Credentials
        run: |
          echo "Checking for hardcoded credentials..."

          # Check for common patterns
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api_key\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
            "-----BEGIN.*PRIVATE KEY-----"
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rniE "$pattern" --include="*.cpp" --include="*.hpp" --include="*.yaml" --include="*.yml" .; then
              echo "Found potential credential: $pattern"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "Warning: Potential hardcoded credentials found. Review the above matches."
          else
            echo "No hardcoded credentials detected"
          fi
        continue-on-error: true

  # ===========================================================================
  # SAST - Static Application Security Testing
  # ===========================================================================
  sast:
    name: SAST Analysis
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Flawfinder
        run: |
          pip install flawfinder

      - name: Run Flawfinder
        run: |
          flawfinder --html --context \
            core/ sinks/ scoops/ apps/ transport/ \
            > flawfinder-report.html 2>&1 || true

          # Also generate text report
          flawfinder --minlevel=2 \
            core/ sinks/ scoops/ apps/ transport/ \
            > flawfinder-report.txt 2>&1 || true

          # Generate SARIF for GitHub Security tab
          flawfinder --sarif \
            core/ sinks/ scoops/ apps/ transport/ \
            > flawfinder-results.sarif 2>&1 || true

          echo "=== Flawfinder Summary ==="
          tail -20 flawfinder-report.txt

      - name: Upload Flawfinder SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: flawfinder-results.sarif

      - name: Upload Flawfinder Report
        uses: actions/upload-artifact@v4
        with:
          name: flawfinder-report
          path: |
            flawfinder-report.html
            flawfinder-report.txt
            flawfinder-results.sarif

      - name: Check for Critical Issues
        run: |
          CRITICAL=$(grep -c "Severity: 5" flawfinder-report.txt || echo 0)
          HIGH=$(grep -c "Severity: 4" flawfinder-report.txt || echo 0)

          echo "Critical issues: $CRITICAL"
          echo "High issues: $HIGH"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "Critical security issues found!"
            grep "Severity: 5" flawfinder-report.txt || true
          fi

  # ===========================================================================
  # Memory Safety Analysis
  # ===========================================================================
  memory-safety:
    name: Memory Safety Analysis
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            clang-18 \
            libjsoncpp-dev \
            libyaml-cpp-dev \
            libpaho-mqtt-dev \
            libpaho-mqttpp-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            libgtest-dev \
            valgrind

      - name: Build with Debug Symbols
        env:
          CC: clang-18
          CXX: clang++-18
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-g -O0" \
            -DBUILD_TESTING=ON \
            -DIPB_SINK_CONSOLE=ON

          cmake --build build --parallel $(nproc)

      - name: Run Valgrind Memory Check
        run: |
          cd build
          mkdir -p valgrind-reports

          # Find test executables
          for test in $(find . -name "*test*" -type f -executable | head -10); do
            TEST_NAME=$(basename "$test")
            echo "Running Valgrind on $test..."
            timeout 120 valgrind --leak-check=full \
              --show-leak-kinds=all \
              --track-origins=yes \
              --xml=yes \
              --xml-file="valgrind-reports/${TEST_NAME}.xml" \
              "$test" 2>&1 | head -100 || true
          done
        continue-on-error: true

      - name: Upload Valgrind Reports
        uses: actions/upload-artifact@v4
        with:
          name: valgrind-reports
          path: build/valgrind-reports/
        continue-on-error: true

  # ===========================================================================
  # OSSF Scorecard
  # ===========================================================================
  scorecard:
    name: OSSF Scorecard
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      security-events: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Run Scorecard Analysis
        uses: ossf/scorecard-action@v2.4.0
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          publish_results: true

      - name: Upload Scorecard Results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: scorecard-results.sarif

  # ===========================================================================
  # License Compliance
  # ===========================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check License Headers
        run: |
          echo "Checking for license headers in source files..."

          # Count files with and without license headers
          TOTAL=0
          WITH_LICENSE=0

          for file in $(find core sinks scoops apps transport -name "*.cpp" -o -name "*.hpp" 2>/dev/null); do
            TOTAL=$((TOTAL + 1))
            if head -10 "$file" | grep -qi "license\|copyright\|MIT\|Apache\|GPL"; then
              WITH_LICENSE=$((WITH_LICENSE + 1))
            fi
          done

          echo "Total source files: $TOTAL"
          echo "Files with license headers: $WITH_LICENSE"
          echo "Files without license headers: $((TOTAL - WITH_LICENSE))"

          # Report to summary
          echo "## License Header Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total files | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| With license | $WITH_LICENSE |" >> $GITHUB_STEP_SUMMARY
          echo "| Without license | $((TOTAL - WITH_LICENSE)) |" >> $GITHUB_STEP_SUMMARY

      - name: Scan Licenses with Scancode
        run: |
          pip install scancode-toolkit
          scancode --license --only-findings --json-pp license-scan.json \
            core/ sinks/ scoops/ apps/ transport/ 2>/dev/null || true
        continue-on-error: true

      - name: Check Third-Party Licenses
        run: |
          echo "Checking third-party dependencies..."

          cat > license-report.md << 'EOF'
          # License Compliance Report

          ## IPB License
          - License: MIT (see LICENSE file)

          ## Third-Party Dependencies

          | Dependency | License | Compatibility |
          |------------|---------|---------------|
          | jsoncpp | MIT | Compatible |
          | yaml-cpp | MIT | Compatible |
          | paho-mqtt-c | EPL-2.0 / EDL-1.0 | Compatible |
          | paho-mqtt-cpp | EPL-2.0 / EDL-1.0 | Compatible |
          | openssl | Apache-2.0 | Compatible |
          | libcurl | MIT/X | Compatible |
          | Google Test | BSD-3-Clause | Compatible |

          ## Compliance Status
          All dependencies use licenses compatible with MIT.
          EOF

          cat license-report.md

      - name: Upload License Report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            license-report.md
            license-scan.json

  # ===========================================================================
  # Security Summary
  # ===========================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-24.04
    needs: [codeql, sbom, dependency-scan, secrets-scan, sast, memory-safety, license-check]
    if: always()
    steps:
      - name: Download Reports
        uses: actions/download-artifact@v4
        with:
          path: reports
        continue-on-error: true

      - name: Generate Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | ${{ needs.codeql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.sbom.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secrets-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST | ${{ needs.sast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Memory Safety | ${{ needs.memory-safety.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM (SPDX & CycloneDX formats)" >> $GITHUB_STEP_SUMMARY
          echo "- Flawfinder SAST report" >> $GITHUB_STEP_SUMMARY
          echo "- Valgrind memory analysis" >> $GITHUB_STEP_SUMMARY
          echo "- License compliance report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from workflow artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        run: |
          # Report status but don't fail - findings should be reviewed in Security tab
          if [ "${{ needs.codeql.result }}" == "failure" ]; then
            echo "::warning::CodeQL analysis failed - review security findings in the Security tab"
          fi
          if [ "${{ needs.sast.result }}" == "failure" ]; then
            echo "::warning::SAST analysis failed - review Flawfinder report"
          fi
          if [ "${{ needs.memory-safety.result }}" == "failure" ]; then
            echo "::warning::Memory safety analysis failed - review Valgrind report"
          fi
          echo "Security scans completed - review any warnings above"
