name: CI Pipeline

on:
  push:
    branches: [main, develop, 'release/*', 'feature/*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run with debug logging'
        required: false
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CMAKE_VERSION: '3.26'
  CCACHE_BASEDIR: ${{ github.workspace }}
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_COMPRESS: 'true'
  CCACHE_COMPRESSLEVEL: '6'
  CCACHE_MAXSIZE: '500M'

jobs:
  # ===========================================================================
  # Code Quality Checks
  # ===========================================================================
  lint:
    name: Code Quality
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-15 cppcheck

      - name: Check Formatting
        run: |
          find core sinks scoops apps transport \
            -name '*.cpp' -o -name '*.hpp' | \
            xargs clang-format-15 --dry-run --Werror

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --inconclusive --force \
            --suppress=missingIncludeSystem \
            --error-exitcode=1 \
            -I core/common/include \
            -I core/components/include \
            -I core/router/include \
            core/ sinks/ scoops/ apps/ 2>&1 | tee cppcheck-report.txt
        continue-on-error: true

      - name: Upload cppcheck Report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.txt

  # ===========================================================================
  # Build Matrix - Tests all build modes (SERVER, EDGE, EMBEDDED)
  # ===========================================================================
  build:
    name: Build (${{ matrix.os }}, ${{ matrix.compiler }}, ${{ matrix.build_mode }}, ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        # Linux GCC - All modes
        os: [ubuntu-22.04]
        build_mode: [SERVER, EDGE, EMBEDDED]
        build_type: [Release, Debug]
        compiler: [gcc-12]
        cc: [gcc-12]
        cxx: [g++-12]
        coverage: [false]
        include:
          # ===========================================
          # Linux - Additional compilers
          # ===========================================
          # Coverage build (SERVER mode only)
          - os: ubuntu-22.04
            compiler: gcc-12
            cc: gcc-12
            cxx: g++-12
            build_mode: SERVER
            build_type: Debug
            coverage: true

          # Clang builds (SERVER mode)
          - os: ubuntu-22.04
            compiler: clang-15
            cc: clang-15
            cxx: clang++-15
            build_mode: SERVER
            build_type: Release
            coverage: false

          - os: ubuntu-22.04
            compiler: clang-15
            cc: clang-15
            cxx: clang++-15
            build_mode: SERVER
            build_type: Debug
            coverage: false

          # ===========================================
          # macOS - All modes (SERVER, EDGE, EMBEDDED)
          # ===========================================
          - os: macos-13
            compiler: clang
            cc: clang
            cxx: clang++
            build_mode: SERVER
            build_type: Release
            coverage: false

          - os: macos-13
            compiler: clang
            cc: clang
            cxx: clang++
            build_mode: SERVER
            build_type: Debug
            coverage: false

          - os: macos-13
            compiler: clang
            cc: clang
            cxx: clang++
            build_mode: EDGE
            build_type: Release
            coverage: false

          - os: macos-13
            compiler: clang
            cc: clang
            cxx: clang++
            build_mode: EDGE
            build_type: Debug
            coverage: false

          - os: macos-13
            compiler: clang
            cc: clang
            cxx: clang++
            build_mode: EMBEDDED
            build_type: Release
            coverage: false

          - os: macos-13
            compiler: clang
            cc: clang
            cxx: clang++
            build_mode: EMBEDDED
            build_type: Debug
            coverage: false

          # ===========================================
          # Windows - All modes
          # ===========================================
          - os: windows-2022
            compiler: msvc
            cc: cl
            cxx: cl
            build_mode: SERVER
            build_type: Release
            coverage: false

          - os: windows-2022
            compiler: msvc
            cc: cl
            cxx: cl
            build_mode: SERVER
            build_type: Debug
            coverage: false

          - os: windows-2022
            compiler: msvc
            cc: cl
            cxx: cl
            build_mode: EDGE
            build_type: Release
            coverage: false

          - os: windows-2022
            compiler: msvc
            cc: cl
            cxx: cl
            build_mode: EDGE
            build_type: Debug
            coverage: false

          - os: windows-2022
            compiler: msvc
            cc: cl
            cxx: cl
            build_mode: EMBEDDED
            build_type: Release
            coverage: false

          - os: windows-2022
            compiler: msvc
            cc: cl
            cxx: cl
            build_mode: EMBEDDED
            build_type: Debug
            coverage: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup ccache (Linux/macOS)
        if: runner.os != 'Windows'
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.build_mode }}-${{ matrix.build_type }}
          max-size: 500M

      # ===========================================
      # Linux Dependencies
      # ===========================================
      - name: Install Dependencies (Linux - SERVER/EDGE)
        if: runner.os == 'Linux' && matrix.build_mode != 'EMBEDDED'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            pkg-config \
            libjsoncpp-dev \
            libyaml-cpp-dev \
            libpaho-mqtt-dev \
            libpaho-mqttpp-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            libgtest-dev \
            libgmock-dev \
            lcov

      - name: Install Dependencies (Linux - EMBEDDED)
        if: runner.os == 'Linux' && matrix.build_mode == 'EMBEDDED'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            pkg-config \
            libcjson-dev \
            libssl-dev \
            libgtest-dev \
            libgmock-dev
          # Note: rapidyaml (ryml) may need to be built from source or skipped

      # ===========================================
      # macOS Dependencies
      # ===========================================
      - name: Install Dependencies (macOS - SERVER/EDGE)
        if: runner.os == 'macOS' && matrix.build_mode != 'EMBEDDED'
        run: |
          brew install \
            cmake \
            ninja \
            jsoncpp \
            yaml-cpp \
            paho-mqtt-c \
            paho-mqtt-cpp \
            curl \
            openssl@3 \
            googletest \
            lcov

      - name: Install Dependencies (macOS - EMBEDDED)
        if: runner.os == 'macOS' && matrix.build_mode == 'EMBEDDED'
        run: |
          brew install \
            cmake \
            ninja \
            cjson \
            openssl@3 \
            googletest

      # ===========================================
      # Windows Dependencies (vcpkg)
      # ===========================================
      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '2024.01.12'

      - name: Install Dependencies (Windows - SERVER/EDGE)
        if: runner.os == 'Windows' && matrix.build_mode != 'EMBEDDED'
        run: |
          vcpkg install jsoncpp:x64-windows yaml-cpp:x64-windows openssl:x64-windows gtest:x64-windows

      - name: Install Dependencies (Windows - EMBEDDED)
        if: runner.os == 'Windows' && matrix.build_mode == 'EMBEDDED'
        run: |
          vcpkg install cjson:x64-windows openssl:x64-windows gtest:x64-windows

      # ===========================================
      # Configure (Linux/macOS)
      # ===========================================
      - name: Configure (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          # Set IPB_FULL only for SERVER mode (EDGE/EMBEDDED use mode defaults)
          FULL_FLAG=""
          if [ "${{ matrix.build_mode }}" = "SERVER" ]; then
            FULL_FLAG="-DIPB_FULL=ON"
          fi

          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DIPB_BUILD_MODE=${{ matrix.build_mode }} \
            -DBUILD_TESTING=ON \
            -DBUILD_EXAMPLES=ON \
            $FULL_FLAG \
            -DENABLE_COVERAGE=${{ matrix.coverage && 'ON' || 'OFF' }}

      # ===========================================
      # Configure (Windows)
      # ===========================================
      - name: Configure (Windows)
        if: runner.os == 'Windows'
        run: |
          $FULL_FLAG = ""
          if ("${{ matrix.build_mode }}" -eq "SERVER") {
            $FULL_FLAG = "-DIPB_FULL=ON"
          }

          cmake -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} `
            -DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake `
            -DIPB_BUILD_MODE=${{ matrix.build_mode }} `
            -DBUILD_TESTING=ON `
            -DBUILD_EXAMPLES=ON `
            $FULL_FLAG

      # ===========================================
      # Build
      # ===========================================
      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        run: cmake --build build --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu)

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: cmake --build build --config ${{ matrix.build_type }} --parallel

      # ===========================================
      # Run Tests
      # ===========================================
      - name: Run Tests (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cd build
          ctest --output-on-failure --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu)

      - name: Run Tests (Windows)
        if: runner.os == 'Windows'
        run: |
          cd build
          ctest -C ${{ matrix.build_type }} --output-on-failure --parallel

      - name: Generate Coverage Report
        if: matrix.coverage
        run: |
          # Install gcovr for coverage reporting
          pip3 install gcovr --quiet

          # Run the test report script with XML output for CI
          chmod +x scripts/run-tests.sh
          ./scripts/run-tests.sh --xml --output-dir test-reports

          # Also generate lcov format for Codecov
          lcov --capture --directory build --output-file coverage.info \
            --ignore-errors mismatch \
            --rc lcov_branch_coverage=1

          lcov --remove coverage.info \
            '/usr/*' \
            '*/tests/*' \
            '*/examples/*' \
            '*/googletest/*' \
            --output-file coverage.info \
            --rc lcov_branch_coverage=1

          lcov --list coverage.info --rc lcov_branch_coverage=1

      - name: Upload Test Reports
        if: matrix.coverage
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.os }}-${{ matrix.compiler }}
          path: |
            test-reports/
          retention-days: 14

      - name: Upload Coverage to Codecov
        if: matrix.coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.info
          flags: unittests
          name: codecov-${{ matrix.os }}-${{ matrix.compiler }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload Build Artifacts
        if: matrix.build_type == 'Release' && matrix.build_mode == 'SERVER'
        uses: actions/upload-artifact@v4
        with:
          name: ipb-${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.build_mode }}
          path: |
            build/apps/ipb-gate/ipb-gate
            build/apps/ipb-bridge/ipb-bridge
          retention-days: 7

  # ===========================================================================
  # Static Analysis
  # ===========================================================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-22.04
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            clang-15 \
            clang-tidy-15 \
            libjsoncpp-dev \
            libyaml-cpp-dev \
            libpaho-mqtt-dev \
            libpaho-mqttpp-dev \
            libcurl4-openssl-dev \
            libssl-dev

      - name: Configure
        env:
          CC: clang-15
          CXX: clang++-15
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DIPB_BUILD_MODE=SERVER \
            -DIPB_FULL=ON

      - name: Run clang-tidy
        run: |
          find core sinks scoops apps transport \
            -name '*.cpp' | head -50 | \
            xargs -P $(nproc) -I{} \
            clang-tidy-15 -p build {} 2>&1 | tee clang-tidy-report.txt
        continue-on-error: true

      - name: Upload clang-tidy Report
        uses: actions/upload-artifact@v4
        with:
          name: clang-tidy-report
          path: clang-tidy-report.txt

  # ===========================================================================
  # Sanitizers
  # ===========================================================================
  sanitizers:
    name: Sanitizer (${{ matrix.sanitizer }})
    runs-on: ubuntu-22.04
    needs: build
    strategy:
      fail-fast: false
      matrix:
        sanitizer: [address, undefined, thread]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            clang-15 \
            libjsoncpp-dev \
            libyaml-cpp-dev \
            libpaho-mqtt-dev \
            libpaho-mqttpp-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            libgtest-dev

      - name: Configure
        env:
          CC: clang-15
          CXX: clang++-15
        run: |
          SANITIZER_FLAGS=""
          case "${{ matrix.sanitizer }}" in
            address)
              SANITIZER_FLAGS="-fsanitize=address -fno-omit-frame-pointer"
              ;;
            undefined)
              SANITIZER_FLAGS="-fsanitize=undefined -fno-omit-frame-pointer"
              ;;
            thread)
              SANITIZER_FLAGS="-fsanitize=thread"
              ;;
          esac

          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="$SANITIZER_FLAGS" \
            -DCMAKE_C_FLAGS="$SANITIZER_FLAGS" \
            -DCMAKE_EXE_LINKER_FLAGS="$SANITIZER_FLAGS" \
            -DBUILD_TESTING=ON \
            -DIPB_SINK_CONSOLE=ON \
            -DIPB_SINK_SYSLOG=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run Tests
        env:
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
          UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
          TSAN_OPTIONS: halt_on_error=1:second_deadlock_stack=1
        run: |
          cd build
          ctest --output-on-failure --parallel 1

  # ===========================================================================
  # Documentation
  # ===========================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Check Documentation Files
        run: |
          echo "Checking documentation completeness..."
          for doc in README.md ARCHITECTURE.md CHANGELOG.md; do
            if [ ! -f "$doc" ]; then
              echo "Missing: $doc"
              exit 1
            fi
          done

          for doc in docs/GETTING_STARTED.md docs/API_REFERENCE.md docs/CONFIGURATION.md; do
            if [ ! -f "$doc" ]; then
              echo "Missing: $doc"
              exit 1
            fi
          done

          echo "All documentation files present"

  # ===========================================================================
  # Integration Tests
  # ===========================================================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-22.04
    needs: build
    services:
      mosquitto:
        image: eclipse-mosquitto:2
        ports:
          - 1883:1883
        options: >-
          --health-cmd "mosquitto_sub -t '#' -C 1 -W 1 || true"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            libjsoncpp-dev \
            libyaml-cpp-dev \
            libpaho-mqtt-dev \
            libpaho-mqttpp-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            mosquitto-clients

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=ON \
            -DIPB_SINK_MQTT=ON \
            -DIPB_SCOOP_MQTT=ON \
            -DIPB_BUILD_GATE=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Test MQTT Connectivity
        run: |
          mosquitto_pub -h localhost -t "test" -m "hello" -q 1
          echo "MQTT broker is accessible"

      - name: Run Integration Tests
        run: |
          cd build
          ctest -L integration --output-on-failure || true

  # ===========================================================================
  # Performance Benchmarks
  # ===========================================================================
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-22.04
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            libjsoncpp-dev \
            libyaml-cpp-dev \
            libpaho-mqtt-dev \
            libpaho-mqttpp-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            libbenchmark-dev

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DIPB_BUILD_MODE=SERVER \
            -DENABLE_OPTIMIZATIONS=ON \
            -DBUILD_TESTING=ON \
            -DIPB_FULL=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run Benchmarks
        run: |
          cd build
          ctest -L benchmark --output-on-failure || true

  # ===========================================================================
  # Final Status
  # ===========================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-22.04
    needs: [build, static-analysis, sanitizers, docs, integration]
    if: always()
    steps:
      - name: Check Status
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Build failed"
            exit 1
          fi
          if [ "${{ needs.docs.result }}" != "success" ]; then
            echo "Documentation check failed"
            exit 1
          fi
          echo "CI pipeline completed successfully"
