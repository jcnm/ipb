name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    types: [opened, reopened]

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  # ==========================================================================
  # Build & Test Matrix
  # ==========================================================================
  build:
    name: Build (${{ matrix.os }}, ${{ matrix.arch }}, ${{ matrix.build_mode }}, ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, macos-15, macos-latest, windows-2022]
        arch: [x64]
        build_mode: [SERVER, EDGE]
        build_type: [Release, Debug]
        include:
          # Add x86 builds for Linux and Windows
          - os: ubuntu-24.04
            arch: x86
            build_mode: SERVER
            build_type: Release
          - os: windows-2022
            arch: x86
            build_mode: SERVER
            build_type: Release
          - os: windows-2022
            arch: x86
            build_mode: EDGE
            build_type: Release
        exclude:
          # Skip Debug builds on macOS to save CI time
          - os: macos-15
            build_type: Debug
          - os: macos-latest
            build_type: Debug
          # Skip Debug builds on Windows to save CI time
          - os: windows-2022
            build_type: Debug

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          chmod +x ./scripts/install-deps-linux.sh
          ./scripts/install-deps-linux.sh --system --no-confirm --arch ${{ matrix.arch }}

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          chmod +x ./scripts/install-deps-macos.sh
          # macOS uses native architecture (arm64 on Apple Silicon, x86_64 on Intel)
          ./scripts/install-deps-macos.sh --skip-brew-update

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          ./scripts/install-deps-windows.ps1 -Arch ${{ matrix.arch }} -UseVcpkg

      - name: Configure CMake (Unix)
        if: runner.os != 'Windows'
        run: |
          # Set CMAKE_PREFIX_PATH for macOS to find Homebrew packages
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            if [[ $(uname -m) == "arm64" ]]; then
              export CMAKE_PREFIX_PATH="/opt/homebrew"
            else
              export CMAKE_PREFIX_PATH="/usr/local"
            fi
          fi
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DIPB_BUILD_MODE=${{ matrix.build_mode }} \
            -DBUILD_TESTING=ON \
            -DBUILD_EXAMPLES=OFF \
            -DIPB_BUILD_BENCHMARKS=OFF \
            ${CMAKE_PREFIX_PATH:+-DCMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH}

      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $vsArch = if ("${{ matrix.arch }}" -eq "x86") { "Win32" } else { "${{ matrix.arch }}" }
          cmake -B build -G "Visual Studio 17 2022" -A $vsArch `
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} `
            -DIPB_BUILD_MODE=${{ matrix.build_mode }} `
            -DBUILD_TESTING=ON `
            -DBUILD_EXAMPLES=OFF `
            -DIPB_BUILD_BENCHMARKS=OFF `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: Run tests
        run: ctest --test-dir build --output-on-failure --timeout 120 -C ${{ matrix.build_type }}

  # ==========================================================================
  # EMBEDDED Mode Build (minimal dependencies)
  # ==========================================================================
  build-embedded:
    name: Build (EMBEDDED mode)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install minimal dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libcjson-dev

      - name: Configure CMake (EMBEDDED)
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DIPB_BUILD_MODE=EMBEDDED \
            -DBUILD_TESTING=ON \
            -DBUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build

      - name: Run tests
        run: ctest --test-dir build --output-on-failure

  # ==========================================================================
  # Code Coverage
  # ==========================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          chmod +x ./scripts/install-deps-linux.sh
          ./scripts/install-deps-linux.sh --system --no-confirm
          # Additional coverage tools
          sudo apt-get install -y lcov

      - name: Configure with coverage
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DIPB_BUILD_MODE=SERVER \
            -DBUILD_TESTING=ON \
            -DENABLE_COVERAGE=ON

      - name: Build
        run: cmake --build build

      - name: Run tests
        run: ctest --test-dir build --output-on-failure

      - name: Generate coverage report
        run: |
          lcov --capture --directory build --output-file coverage.info
          lcov --remove coverage.info '/usr/*' '*/tests/*' '*/examples/*' --output-file coverage.info
          lcov --list coverage.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.info
          fail_ci_if_error: false
          verbose: true

  # ==========================================================================
  # Sanitizers (ASan, UBSan)
  # ==========================================================================
  sanitizers:
    name: Sanitizers (ASan + UBSan)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          chmod +x ./scripts/install-deps-linux.sh
          ./scripts/install-deps-linux.sh --system --no-confirm

      - name: Configure with sanitizers
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DIPB_BUILD_MODE=SERVER \
            -DBUILD_TESTING=ON \
            -DENABLE_SANITIZERS=ON

      - name: Build
        run: cmake --build build

      - name: Run tests with sanitizers
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
        run: ctest --test-dir build --output-on-failure --timeout 300

  # ==========================================================================
  # Static Analysis (clang-tidy)
  # ==========================================================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          chmod +x ./scripts/install-deps-linux.sh
          ./scripts/install-deps-linux.sh --system --no-confirm
          # clang-tidy is already installed by the script

      - name: Configure
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DIPB_BUILD_MODE=SERVER \
            -DBUILD_TESTING=OFF

      - name: Run clang-tidy
        run: |
          find core sinks scoops transport \
            -name '*.cpp' -o -name '*.hpp' | \
            head -50 | \
            xargs -I {} clang-tidy {} -p build --quiet 2>/dev/null || true

  # ==========================================================================
  # Format Check
  # ==========================================================================
  format:
    name: Format Check
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format

      - name: Check formatting
        run: |
          find core sinks scoops transport apps \
            -name '*.cpp' -o -name '*.hpp' -o -name '*.h' | \
            xargs clang-format --dry-run --Werror 2>&1 | head -100 || echo "Format check completed"
