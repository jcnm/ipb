name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.5.0)'
        required: true
      prerelease:
        description: 'Is this a pre-release?'
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

env:
  CMAKE_VERSION: '3.26'

jobs:
  # ===========================================================================
  # Prepare Release
  # ===========================================================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.version }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            if [[ "$VERSION" == *"-"* ]]; then
              PRERELEASE="true"
            else
              PRERELEASE="false"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (prerelease: $PRERELEASE)"

      - name: Validate Version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "Invalid version format: $VERSION"
            exit 1
          fi

  # ===========================================================================
  # Build Release Artifacts
  # ===========================================================================
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            artifact_name: ipb-linux-x64
            archive_type: tar.gz

          - os: ubuntu-20.04
            artifact_name: ipb-linux-x64-ubuntu20
            archive_type: tar.gz

          - os: macos-13
            artifact_name: ipb-macos-x64
            archive_type: tar.gz

          - os: macos-14
            artifact_name: ipb-macos-arm64
            archive_type: tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            pkg-config \
            libjsoncpp-dev \
            libyaml-cpp-dev \
            libpaho-mqtt-dev \
            libpaho-mqttpp-dev \
            libcurl4-openssl-dev \
            libssl-dev

      - name: Install Dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install \
            cmake \
            ninja \
            jsoncpp \
            yaml-cpp \
            paho-mqtt-c \
            paho-mqtt-cpp \
            curl \
            openssl@3

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_OPTIMIZATIONS=ON \
            -DENABLE_LTO=ON \
            -DIPB_FULL=ON \
            -DBUILD_TESTING=OFF \
            -DBUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu)

      - name: Create Package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          PACKAGE_NAME="${{ matrix.artifact_name }}-$VERSION"

          mkdir -p "$PACKAGE_NAME/bin"
          mkdir -p "$PACKAGE_NAME/lib"
          mkdir -p "$PACKAGE_NAME/include"
          mkdir -p "$PACKAGE_NAME/config"
          mkdir -p "$PACKAGE_NAME/docs"

          # Copy binaries
          cp build/apps/ipb-gate/ipb-gate "$PACKAGE_NAME/bin/" 2>/dev/null || true
          cp build/apps/ipb-bridge/ipb-bridge "$PACKAGE_NAME/bin/" 2>/dev/null || true

          # Copy libraries
          find build -name "*.so" -o -name "*.dylib" -o -name "*.a" | \
            xargs -I{} cp {} "$PACKAGE_NAME/lib/" 2>/dev/null || true

          # Copy headers
          cp -r core/common/include/ipb "$PACKAGE_NAME/include/"
          cp -r core/components/include/ipb/core "$PACKAGE_NAME/include/ipb/" 2>/dev/null || true

          # Copy config examples
          cp examples/*.yaml "$PACKAGE_NAME/config/" 2>/dev/null || true

          # Copy documentation
          cp README.md ARCHITECTURE.md CHANGELOG.md "$PACKAGE_NAME/docs/"
          cp docs/*.md "$PACKAGE_NAME/docs/" 2>/dev/null || true

          # Create archive
          if [ "${{ matrix.archive_type }}" == "tar.gz" ]; then
            tar -czvf "$PACKAGE_NAME.tar.gz" "$PACKAGE_NAME"
          else
            zip -r "$PACKAGE_NAME.zip" "$PACKAGE_NAME"
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            *.tar.gz
            *.zip
          retention-days: 5

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-22.04
    needs: [prepare, build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Assets
        run: |
          mkdir -p release-assets
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) \
            -exec cp {} release-assets/ \;
          ls -la release-assets/

      - name: Generate Checksums
        run: |
          cd release-assets
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Extract Changelog
        id: changelog
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          # Extract changelog for this version
          awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | head -n -1 > release-notes.md
          if [ ! -s release-notes.md ]; then
            echo "## Release $VERSION" > release-notes.md
            echo "" >> release-notes.md
            echo "See CHANGELOG.md for details." >> release-notes.md
          fi
          cat release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: IPB v${{ needs.prepare.outputs.version }}
          tag_name: v${{ needs.prepare.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ needs.prepare.outputs.prerelease == 'true' }}
          files: |
            release-assets/*
          generate_release_notes: true

  # ===========================================================================
  # Docker Image
  # ===========================================================================
  docker:
    name: Build Docker Image
    runs-on: ubuntu-22.04
    needs: [prepare, build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: ipb-linux-x64
          path: docker-build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Dockerfile
        run: |
          cat > Dockerfile << 'EOF'
          FROM ubuntu:22.04

          RUN apt-get update && apt-get install -y \
              libjsoncpp25 \
              libyaml-cpp0.7 \
              libpaho-mqtt3as1 \
              libpaho-mqttpp3-1 \
              libcurl4 \
              libssl3 \
              && rm -rf /var/lib/apt/lists/*

          WORKDIR /opt/ipb

          COPY docker-build/*.tar.gz /tmp/
          RUN tar -xzf /tmp/*.tar.gz -C /opt/ipb --strip-components=1 \
              && rm /tmp/*.tar.gz

          ENV PATH="/opt/ipb/bin:$PATH"

          EXPOSE 1883 8080

          ENTRYPOINT ["ipb-gate"]
          CMD ["--help"]
          EOF

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ needs.prepare.outputs.version }}
            ghcr.io/${{ github.repository }}:latest
          labels: |
            org.opencontainers.image.title=IPB
            org.opencontainers.image.description=Industrial Protocol Bridge
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}

  # ===========================================================================
  # Notify
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-22.04
    needs: [prepare, release, docker]
    if: always()
    steps:
      - name: Release Status
        run: |
          if [ "${{ needs.release.result }}" == "success" ]; then
            echo "Release v${{ needs.prepare.outputs.version }} created successfully!"
          else
            echo "Release failed"
            exit 1
          fi
